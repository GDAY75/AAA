<div class="gallery-show" data-controller="lightbox masonry" data-sidebar-target="galleries">
  <div class="title-spotlights is-animated">
    <div class="spotlight"></div>
    <div class="spotlight"></div>
    <h1 class="asso-title"><%= @gallery.title %></h1>
  </div>

  <% if @gallery.category == "Répètes"%>
    <div class="photo-credit">
      <span>Photos prises par :</span>
      <%= link_to "https://horo-photographie.com/", target: "_blank", rel: "noopener" do %>
        <%= image_tag "photographe.png", alt: "Horo Photographie", class: "photo-credit__logo" %>
      <% end %>
    </div>
  <% end %>

  <div class="photos-source" data-masonry-target="source">
    <% @photos.each_with_index do |photo, idx| %>
      <% public_id = photo[:image] %> <!-- ⚠️ bien photo[:image] et pas photo.image -->
      <% next if public_id.blank? %>

      <% caption = (photo.caption.presence || @gallery.title) %>

      <%# URL grande pour la lightbox %>
      <% full_url = Cloudinary::Utils.cloudinary_url(
        public_id,
        width: 1920,
        height: 1080,
        crop: :fit,
        fetch_format: :auto,
        quality: :auto
      ) %>

      <%# URL thumb plus légère pour la grille %>
      <% thumb_url = Cloudinary::Utils.cloudinary_url(
        public_id,
        width: 800,
        height: 800,
        crop: :fill,
        fetch_format: :auto,
        quality: :auto
      ) %>

      <%= link_to "#",
          class: "photo-tile",
          data: {
            masonry_item: true,
            action: "click->lightbox#open",
            lightbox_target: "thumb",
            index: idx,
            image_url: full_url,
            caption: caption
          } do %>

        <%= image_tag thumb_url,
            alt: caption,
            loading: "lazy" %>
      <% end %>
    <% end %>
  </div>


  <!-- Conteneur des colonnes générées par Stimulus -->
  <div class="photos-grid" data-masonry-target="grid"></div>

  <!-- Lightbox (Stimulus) inchangée -->
  <div class="lightbox" data-lightbox-target="modal" aria-hidden="true">
    <a href="#" class="lightbox-close" data-action="click->lightbox#close" aria-label="Fermer"><i class="fa-solid fa-xmark"></i></a>

    <!-- Boutons navigation -->
    <button class="lightbox-prev" type="button" data-action="click->lightbox#prev" aria-label="Précédente"><i class="fa-solid fa-chevron-left"></i></button>
    <button class="lightbox-next" type="button" data-action="click->lightbox#next" aria-label="Suivante"><i class="fa-solid fa-chevron-right"></i></button>

    <!-- Outils de zoom -->
    <div class="lightbox-tools">
      <button type="button" class="tool-btn" data-action="click->lightbox#zoomOut">−</button>
      <button type="button" class="tool-btn" data-action="click->lightbox#zoomIn">+</button>
      <button type="button" class="tool-btn" data-action="click->lightbox#zoomReset">100%</button>
    </div>

    <div class="lightbox-content">
      <!-- Viewport scroll/drag -->
      <div class="lightbox-viewport"
          data-lightbox-target="viewport"
          data-action="wheel->lightbox#wheelZoom click->lightbox#toggleZoom
                        pointerdown->lightbox#panStart pointermove->lightbox#panMove pointerup->lightbox#panEnd pointercancel->lightbox#panEnd pointerleave->lightbox#panEnd">
        <img data-lightbox-target="image" alt="">
      </div>

      <div class="lightbox-caption" data-lightbox-target="caption"></div>
    </div>
  </div>
</div>
