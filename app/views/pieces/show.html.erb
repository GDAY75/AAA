<div class="piece-show" data-sidebar-target="pieces">

  <%# --- Bannière : on utilise l'affiche v2 nommée "<TITRE> 2.JPG" --- %>
  <% banner_name = @piece.title.parameterize.underscore + "_2" %>
  <div class="piece-banner" style="background-image: url('<%= cl_image_path(banner_name) %>')">
    <h1 class="piece-banner__title"><%= @piece.title %></h1>
  </div>



  <div class="piece-content">
    <% if @piece.respond_to?(:description) && @piece.description.present? %>
      <div class="piece-desc">
        <%= simple_format(@piece.description) %>
      </div>
    <% end %>

    <%# Auteur %>
    <% author = @piece.try(:author) || @piece.try(:auteur) %>
    <div class="piece-director">
    <% if author.present? %>
      <p class="piece-author"><span>Auteur : </span>&nbsp;<%= author %></p>
    <% end %>

    <div class="section-separator">✦</div>

      <p class="piece-author">
        <span>Mise en scène : </span>&nbsp;
        <%= link_to member_path(@piece.member), class: "director-link" do %>
          <%= @piece.member.first_name %>&nbsp;<%= @piece.member.last_name.titleize %>
        <% end %>

      </p>

      <div class="star-photo">
        <svg class="star-svg" viewBox="0 0 100 100" aria-hidden="true" role="img">
          <defs>
            <!-- Etoile pour le découpage -->
            <clipPath id="starClip" clipPathUnits="objectBoundingBox">
              <polygon points="
                0.50 0.00, 0.61 0.35, 0.98 0.35,
                0.68 0.57, 0.79 0.91, 0.50 0.70,
                0.21 0.91, 0.32 0.57, 0.02 0.35,
                0.39 0.35
              "/>
            </clipPath>
          </defs>

          <!-- Image découpée -->
          <image
            x="0" y="0" width="100" height="100"
            preserveAspectRatio="xMidYMid slice"
            clip-path="url(#starClip)"
            xlink:href="<%= cl_image_path(@piece.title.parameterize.underscore + '_3') %>" />

          <!-- Bordure dorée -->
          <polygon class="star-stroke" points="
            50 0, 61 35, 98 35,
            68 57, 79 91, 50 70,
            21 91, 32 57, 2 35,
            39 35
          " fill="none" />
        </svg>
      </div>
    </div>

    <div class="section-separator">✦</div>

    <p class="piece-author piece-comedien">
      <span>Comédiens :</span>
      <ul>
        <% @members.each do |member| %>
          <div class="piece-comedien">
            <%= link_to member_path(member), class: "director-link" do %>
              <p><%= member.first_name %> <%= member.last_name.titleize %></p>
            <% end %>

            <% roles_count = member.castings.where(piece: @piece).count %>
            <% if roles_count > 1 %>
              <p>dans les rôles de :</p>
            <% else %>
              <p>dans le rôle de :</p>
            <% end %>
            <div class="member-roles">
              <% member.castings.where(piece: @piece).each do |casting| %>
                <div class="member-role">
                  <% if casting.photo.present? %>
                    <div class="casting-photo-oval">
                      <%= cl_image_tag casting.photo, alt: casting.role, class: "oval-img" %>
                    </div>
                  <% end %>
                  <div class="role-name"><%= casting.role %></div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </ul>
    </p>
  </div>
  <div class="section-separator">✦</div>
  <% if @gallery.present? %>
    <div class="medias-piece">
      <p class="piece-author"><span>Photos de la Pièce :</span></p>
      <%= link_to gallery_path(@gallery), class: "gal-card gal-card--large" do %>
        <div class="gal-cover"
              data-controller="galcover"
              data-galcover-interval-value="2400"
              data-galcover-autoplay-value="true">
            <div class="gal-cover-stack" data-galcover-target="stack">
              <% images = [] %>

              <% if @gallery.respond_to?(:photos) %>
                <% @gallery.photos.to_a.sample(6).each do |p| %>
                  <% public_id = p[:image] %>
                  <% next if public_id.blank? %>

                  <% images << Cloudinary::Utils.cloudinary_url(
                    public_id,
                    width: 800,
                    crop: :fit,
                    fetch_format: :auto,
                    quality: :auto
                  ) %>
                <% end %>
              <% end %>

              <% if images.any? %>
                <% images.each_with_index do |src, i| %>
                  <img src="<%= src %>"
                      alt="<%= "#{@gallery.title} – photo #{i+1}" %>"
                      class="gal-slide <%= 'is-active' if i.zero? %>"
                      loading="<%= i.zero? ? 'eager' : 'lazy' %>">
                <% end %>
              <% elsif @gallery.cover.present? %>
                <%= cl_image_tag @gallery.cover, alt: @gallery.title, class: "gal-slide is-active" %>
              <% else %>
                <div class="cover-placeholder">Aucune image</div>
              <% end %>
            </div>
          </div>
        <h2 class="gal-name"><%= @gallery.title %></h2>
      <% end %>
    </div>
  <% end %>
  <% if @piece.videos.present? %>
    <div class="medias-piece">
      <p class="piece-author"><span>Vidéos de la Pièce :</span></p>
      <% @piece.videos.order(position: :asc, created_at: :asc).each do |v| %>
        <div class="video-card video-card--large" data-videothumb-target="card">
          <div class="thumb-wrap"
              data-action="click->videomodal#open"
              data-video-url="<%= asset_path(v.file) %>">
            <img data-videothumb-target="img" alt="<%= v.title %>">
            <div class="play-badge">▶</div>
          </div>
          <span data-videothumb-target="src" data-src="<%= asset_path(v.file) %>"></span>
          <div class="video-meta">
            <p class="video-title"><%= v.title %></p>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
